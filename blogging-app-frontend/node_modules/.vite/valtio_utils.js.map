{
  "version": 3,
  "sources": ["../valtio/esm/utils.js"],
  "sourcesContent": ["import { createProxy, isChanged } from 'proxy-compare';\nimport { subscribe, snapshot, proxy, ref } from 'valtio/vanilla';\n\nconst subscribeKey = (proxyObject, key, callback, notifyInSync) => subscribe(proxyObject, (ops) => {\n  if (ops.some((op) => op[1][0] === key)) {\n    callback(proxyObject[key]);\n  }\n}, notifyInSync);\nconst devtools = (proxyObject, name) => {\n  let extension;\n  try {\n    extension = window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch {\n  }\n  if (!extension) {\n    if (typeof process === \"object\" && process.env.NODE_ENV === \"development\" && typeof window !== \"undefined\") {\n      console.warn(\"[Warning] Please install/enable Redux devtools extension\");\n    }\n    return;\n  }\n  let isTimeTraveling = false;\n  const devtools2 = extension.connect({ name });\n  const unsub1 = subscribe(proxyObject, () => {\n    if (isTimeTraveling) {\n      isTimeTraveling = false;\n    } else {\n      devtools2.send(`Update - ${new Date().toLocaleString()}`, snapshot(proxyObject));\n    }\n  });\n  const unsub2 = devtools2.subscribe((message) => {\n    var _a, _b, _c, _d, _e, _f;\n    if (message.type === \"DISPATCH\" && message.state) {\n      if (((_a = message.payload) == null ? void 0 : _a.type) === \"JUMP_TO_ACTION\" || ((_b = message.payload) == null ? void 0 : _b.type) === \"JUMP_TO_STATE\") {\n        isTimeTraveling = true;\n      }\n      const nextValue = JSON.parse(message.state);\n      Object.keys(nextValue).forEach((key) => {\n        proxyObject[key] = nextValue[key];\n      });\n    } else if (message.type === \"DISPATCH\" && ((_c = message.payload) == null ? void 0 : _c.type) === \"COMMIT\") {\n      devtools2.init(snapshot(proxyObject));\n    } else if (message.type === \"DISPATCH\" && ((_d = message.payload) == null ? void 0 : _d.type) === \"IMPORT_STATE\") {\n      const actions = (_e = message.payload.nextLiftedState) == null ? void 0 : _e.actionsById;\n      const computedStates = ((_f = message.payload.nextLiftedState) == null ? void 0 : _f.computedStates) || [];\n      isTimeTraveling = true;\n      computedStates.forEach(({ state }, index) => {\n        const action = actions[index] || `Update - ${new Date().toLocaleString()}`;\n        Object.keys(state).forEach((key) => {\n          proxyObject[key] = state[key];\n        });\n        if (index === 0) {\n          devtools2.init(snapshot(proxyObject));\n        } else {\n          devtools2.send(action, snapshot(proxyObject));\n        }\n      });\n    }\n  });\n  devtools2.init(snapshot(proxyObject));\n  return () => {\n    unsub1();\n    unsub2();\n  };\n};\nconst addComputed = (proxyObject, computedFns, targetObject = proxyObject) => {\n  Object.keys(computedFns).forEach((key) => {\n    if (Object.getOwnPropertyDescriptor(targetObject, key)) {\n      throw new Error(\"object property already defined\");\n    }\n    const get = computedFns[key];\n    let prevSnapshot;\n    let affected = new WeakMap();\n    let pending = false;\n    const callback = () => {\n      const nextSnapshot = snapshot(proxyObject);\n      if (!pending && (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected))) {\n        affected = new WeakMap();\n        const value = get(createProxy(nextSnapshot, affected));\n        prevSnapshot = nextSnapshot;\n        if (value instanceof Promise) {\n          pending = true;\n          value.then((v) => {\n            targetObject[key] = v;\n          }).catch((e) => {\n            targetObject[key] = new Proxy({}, {\n              get() {\n                throw e;\n              }\n            });\n          }).finally(() => {\n            pending = false;\n          });\n        }\n        targetObject[key] = value;\n      }\n    };\n    subscribe(proxyObject, callback);\n    callback();\n  });\n};\nconst proxyWithComputed = (initialObject, computedFns) => {\n  Object.keys(computedFns).forEach((key) => {\n    if (Object.getOwnPropertyDescriptor(initialObject, key)) {\n      throw new Error(\"object property already defined\");\n    }\n    const computedFn = computedFns[key];\n    const { get, set } = typeof computedFn === \"function\" ? { get: computedFn } : computedFn;\n    let computedValue;\n    let prevSnapshot;\n    let affected = new WeakMap();\n    const desc = {};\n    desc.get = () => {\n      const nextSnapshot = snapshot(proxyObject);\n      if (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected)) {\n        affected = new WeakMap();\n        computedValue = get(createProxy(nextSnapshot, affected));\n        prevSnapshot = nextSnapshot;\n      }\n      return computedValue;\n    };\n    if (set) {\n      desc.set = (newValue) => set(proxyObject, newValue);\n    }\n    Object.defineProperty(initialObject, key, desc);\n  });\n  const proxyObject = proxy(initialObject);\n  return proxyObject;\n};\nlet currentCleanups;\nconst watch = (callback) => {\n  const cleanups = new Set();\n  const subscriptions = new Set();\n  let alive = true;\n  const cleanup = () => {\n    cleanups.forEach((clean) => {\n      clean();\n    });\n    cleanups.clear();\n    subscriptions.clear();\n  };\n  const revalidate = () => {\n    if (!alive) {\n      return;\n    }\n    cleanup();\n    const parent = currentCleanups;\n    currentCleanups = cleanups;\n    try {\n      const cleanupReturn = callback((proxy2) => {\n        subscriptions.add(proxy2);\n        return proxy2;\n      });\n      if (cleanupReturn) {\n        cleanups.add(cleanupReturn);\n      }\n    } finally {\n      currentCleanups = parent;\n    }\n    subscriptions.forEach((proxy2) => {\n      const clean = subscribe(proxy2, revalidate);\n      cleanups.add(clean);\n    });\n  };\n  const wrappedCleanup = () => {\n    if (alive) {\n      cleanup();\n      alive = false;\n    }\n  };\n  if (currentCleanups) {\n    currentCleanups.add(wrappedCleanup);\n  }\n  revalidate();\n  return wrappedCleanup;\n};\nconst proxyWithHistory = (initialValue) => {\n  const proxyObject = proxy({\n    value: initialValue,\n    history: ref({\n      wip: initialValue,\n      snapshots: [],\n      index: -1\n    }),\n    canUndo: () => proxyObject.history.index > 0,\n    undo: () => {\n      if (proxyObject.canUndo()) {\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[--proxyObject.history.index];\n      }\n    },\n    canRedo: () => proxyObject.history.index < proxyObject.history.snapshots.length - 1,\n    redo: () => {\n      if (proxyObject.canRedo()) {\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[++proxyObject.history.index];\n      }\n    },\n    saveHistory: () => {\n      proxyObject.history.snapshots.splice(proxyObject.history.index + 1);\n      proxyObject.history.snapshots.push(snapshot(proxyObject).value);\n      ++proxyObject.history.index;\n    }\n  });\n  subscribe(proxyObject, (ops) => {\n    if (ops.some((op) => op[1][0] === \"value\" && (op[0] !== \"set\" || op[2] !== proxyObject.history.wip))) {\n      proxyObject.saveHistory();\n    }\n  });\n  return proxyObject;\n};\n\nexport { addComputed, devtools, proxyWithComputed, proxyWithHistory, subscribeKey, watch };\n"],
  "mappings": "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",
  "names": []
}
