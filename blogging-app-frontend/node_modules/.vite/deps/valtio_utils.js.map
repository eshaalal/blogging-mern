{
  "version": 3,
  "sources": ["../../valtio/esm/utils.js"],
  "sourcesContent": ["import { createProxy, isChanged } from 'proxy-compare';\nimport { subscribe, snapshot, proxy, ref } from 'valtio/vanilla';\n\nconst subscribeKey = (proxyObject, key, callback, notifyInSync) => subscribe(proxyObject, (ops) => {\n  if (ops.some((op) => op[1][0] === key)) {\n    callback(proxyObject[key]);\n  }\n}, notifyInSync);\nconst devtools = (proxyObject, name) => {\n  let extension;\n  try {\n    extension = window.__REDUX_DEVTOOLS_EXTENSION__;\n  } catch {\n  }\n  if (!extension) {\n    if (typeof process === \"object\" && process.env.NODE_ENV === \"development\" && typeof window !== \"undefined\") {\n      console.warn(\"[Warning] Please install/enable Redux devtools extension\");\n    }\n    return;\n  }\n  let isTimeTraveling = false;\n  const devtools2 = extension.connect({ name });\n  const unsub1 = subscribe(proxyObject, () => {\n    if (isTimeTraveling) {\n      isTimeTraveling = false;\n    } else {\n      devtools2.send(`Update - ${new Date().toLocaleString()}`, snapshot(proxyObject));\n    }\n  });\n  const unsub2 = devtools2.subscribe((message) => {\n    var _a, _b, _c, _d, _e, _f;\n    if (message.type === \"DISPATCH\" && message.state) {\n      if (((_a = message.payload) == null ? void 0 : _a.type) === \"JUMP_TO_ACTION\" || ((_b = message.payload) == null ? void 0 : _b.type) === \"JUMP_TO_STATE\") {\n        isTimeTraveling = true;\n      }\n      const nextValue = JSON.parse(message.state);\n      Object.keys(nextValue).forEach((key) => {\n        proxyObject[key] = nextValue[key];\n      });\n    } else if (message.type === \"DISPATCH\" && ((_c = message.payload) == null ? void 0 : _c.type) === \"COMMIT\") {\n      devtools2.init(snapshot(proxyObject));\n    } else if (message.type === \"DISPATCH\" && ((_d = message.payload) == null ? void 0 : _d.type) === \"IMPORT_STATE\") {\n      const actions = (_e = message.payload.nextLiftedState) == null ? void 0 : _e.actionsById;\n      const computedStates = ((_f = message.payload.nextLiftedState) == null ? void 0 : _f.computedStates) || [];\n      isTimeTraveling = true;\n      computedStates.forEach(({ state }, index) => {\n        const action = actions[index] || `Update - ${new Date().toLocaleString()}`;\n        Object.keys(state).forEach((key) => {\n          proxyObject[key] = state[key];\n        });\n        if (index === 0) {\n          devtools2.init(snapshot(proxyObject));\n        } else {\n          devtools2.send(action, snapshot(proxyObject));\n        }\n      });\n    }\n  });\n  devtools2.init(snapshot(proxyObject));\n  return () => {\n    unsub1();\n    unsub2();\n  };\n};\nconst addComputed = (proxyObject, computedFns, targetObject = proxyObject) => {\n  Object.keys(computedFns).forEach((key) => {\n    if (Object.getOwnPropertyDescriptor(targetObject, key)) {\n      throw new Error(\"object property already defined\");\n    }\n    const get = computedFns[key];\n    let prevSnapshot;\n    let affected = new WeakMap();\n    let pending = false;\n    const callback = () => {\n      const nextSnapshot = snapshot(proxyObject);\n      if (!pending && (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected))) {\n        affected = new WeakMap();\n        const value = get(createProxy(nextSnapshot, affected));\n        prevSnapshot = nextSnapshot;\n        if (value instanceof Promise) {\n          pending = true;\n          value.then((v) => {\n            targetObject[key] = v;\n          }).catch((e) => {\n            targetObject[key] = new Proxy({}, {\n              get() {\n                throw e;\n              }\n            });\n          }).finally(() => {\n            pending = false;\n          });\n        }\n        targetObject[key] = value;\n      }\n    };\n    subscribe(proxyObject, callback);\n    callback();\n  });\n};\nconst proxyWithComputed = (initialObject, computedFns) => {\n  Object.keys(computedFns).forEach((key) => {\n    if (Object.getOwnPropertyDescriptor(initialObject, key)) {\n      throw new Error(\"object property already defined\");\n    }\n    const computedFn = computedFns[key];\n    const { get, set } = typeof computedFn === \"function\" ? { get: computedFn } : computedFn;\n    let computedValue;\n    let prevSnapshot;\n    let affected = new WeakMap();\n    const desc = {};\n    desc.get = () => {\n      const nextSnapshot = snapshot(proxyObject);\n      if (!prevSnapshot || isChanged(prevSnapshot, nextSnapshot, affected)) {\n        affected = new WeakMap();\n        computedValue = get(createProxy(nextSnapshot, affected));\n        prevSnapshot = nextSnapshot;\n      }\n      return computedValue;\n    };\n    if (set) {\n      desc.set = (newValue) => set(proxyObject, newValue);\n    }\n    Object.defineProperty(initialObject, key, desc);\n  });\n  const proxyObject = proxy(initialObject);\n  return proxyObject;\n};\nlet currentCleanups;\nconst watch = (callback) => {\n  const cleanups = new Set();\n  const subscriptions = new Set();\n  let alive = true;\n  const cleanup = () => {\n    cleanups.forEach((clean) => {\n      clean();\n    });\n    cleanups.clear();\n    subscriptions.clear();\n  };\n  const revalidate = () => {\n    if (!alive) {\n      return;\n    }\n    cleanup();\n    const parent = currentCleanups;\n    currentCleanups = cleanups;\n    try {\n      const cleanupReturn = callback((proxy2) => {\n        subscriptions.add(proxy2);\n        return proxy2;\n      });\n      if (cleanupReturn) {\n        cleanups.add(cleanupReturn);\n      }\n    } finally {\n      currentCleanups = parent;\n    }\n    subscriptions.forEach((proxy2) => {\n      const clean = subscribe(proxy2, revalidate);\n      cleanups.add(clean);\n    });\n  };\n  const wrappedCleanup = () => {\n    if (alive) {\n      cleanup();\n      alive = false;\n    }\n  };\n  if (currentCleanups) {\n    currentCleanups.add(wrappedCleanup);\n  }\n  revalidate();\n  return wrappedCleanup;\n};\nconst proxyWithHistory = (initialValue) => {\n  const proxyObject = proxy({\n    value: initialValue,\n    history: ref({\n      wip: initialValue,\n      snapshots: [],\n      index: -1\n    }),\n    canUndo: () => proxyObject.history.index > 0,\n    undo: () => {\n      if (proxyObject.canUndo()) {\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[--proxyObject.history.index];\n      }\n    },\n    canRedo: () => proxyObject.history.index < proxyObject.history.snapshots.length - 1,\n    redo: () => {\n      if (proxyObject.canRedo()) {\n        proxyObject.value = proxyObject.history.wip = proxyObject.history.snapshots[++proxyObject.history.index];\n      }\n    },\n    saveHistory: () => {\n      proxyObject.history.snapshots.splice(proxyObject.history.index + 1);\n      proxyObject.history.snapshots.push(snapshot(proxyObject).value);\n      ++proxyObject.history.index;\n    }\n  });\n  subscribe(proxyObject, (ops) => {\n    if (ops.some((op) => op[1][0] === \"value\" && (op[0] !== \"set\" || op[2] !== proxyObject.history.wip))) {\n      proxyObject.saveHistory();\n    }\n  });\n  return proxyObject;\n};\n\nexport { addComputed, devtools, proxyWithComputed, proxyWithHistory, subscribeKey, watch };\n"],
  "mappings": "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",
  "names": []
}
