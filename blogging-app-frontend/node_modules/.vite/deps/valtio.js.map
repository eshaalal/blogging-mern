{
  "version": 3,
  "sources": ["../../valtio/esm/index.js"],
  "sourcesContent": ["import { snapshot, subscribe, getVersion } from 'valtio/vanilla';\nexport * from 'valtio/vanilla';\nimport { useRef, useState, useEffect, useReducer, useCallback, useMemo, useLayoutEffect, useDebugValue } from 'react';\nimport { isChanged, createProxy, affectedToPathList } from 'proxy-compare';\n\nconst TARGET = Symbol();\nconst GET_VERSION = Symbol();\nconst createMutableSource = (target, getVersion) => ({\n  [TARGET]: target,\n  [GET_VERSION]: getVersion\n});\nconst useMutableSource = (source, getSnapshot, subscribe) => {\n  const lastVersion = useRef(0);\n  const currentVersion = source[GET_VERSION](source[TARGET]);\n  const [state, setState] = useState(() => [\n    source,\n    getSnapshot,\n    subscribe,\n    currentVersion,\n    getSnapshot(source[TARGET])\n  ]);\n  let currentSnapshot = state[4];\n  if (state[0] !== source || state[1] !== getSnapshot || state[2] !== subscribe) {\n    currentSnapshot = getSnapshot(source[TARGET]);\n    setState([\n      source,\n      getSnapshot,\n      subscribe,\n      currentVersion,\n      currentSnapshot\n    ]);\n  } else if (currentVersion !== state[3] && currentVersion !== lastVersion.current) {\n    currentSnapshot = getSnapshot(source[TARGET]);\n    if (!Object.is(currentSnapshot, state[4])) {\n      setState([\n        source,\n        getSnapshot,\n        subscribe,\n        currentVersion,\n        currentSnapshot\n      ]);\n    }\n  }\n  useEffect(() => {\n    let didUnsubscribe = false;\n    const checkForUpdates = () => {\n      if (didUnsubscribe) {\n        return;\n      }\n      try {\n        const nextSnapshot = getSnapshot(source[TARGET]);\n        const nextVersion = source[GET_VERSION](source[TARGET]);\n        lastVersion.current = nextVersion;\n        setState((prev) => {\n          if (prev[0] !== source || prev[1] !== getSnapshot || prev[2] !== subscribe) {\n            return prev;\n          }\n          if (Object.is(prev[4], nextSnapshot)) {\n            return prev;\n          }\n          return [\n            prev[0],\n            prev[1],\n            prev[2],\n            nextVersion,\n            nextSnapshot\n          ];\n        });\n      } catch (e) {\n        setState((prev) => [...prev]);\n      }\n    };\n    const unsubscribe = subscribe(source[TARGET], checkForUpdates);\n    checkForUpdates();\n    return () => {\n      didUnsubscribe = true;\n      unsubscribe();\n    };\n  }, [source, getSnapshot, subscribe]);\n  return currentSnapshot;\n};\n\nconst isSSR = typeof window === \"undefined\" || !window.navigator || /ServerSideRendering|^Deno\\//.test(window.navigator.userAgent);\nconst useIsomorphicLayoutEffect = isSSR ? useEffect : useLayoutEffect;\nconst useAffectedDebugValue = (state, affected) => {\n  const pathList = useRef();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(pathList.current);\n};\nconst mutableSourceCache = new WeakMap();\nconst getMutableSource = (proxyObject) => {\n  if (!mutableSourceCache.has(proxyObject)) {\n    mutableSourceCache.set(proxyObject, createMutableSource(proxyObject, getVersion));\n  }\n  return mutableSourceCache.get(proxyObject);\n};\nconst useSnapshot = (proxyObject, options) => {\n  const forceUpdate = useReducer((c) => c + 1, 0)[1];\n  const affected = new WeakMap();\n  const lastAffected = useRef();\n  const prevSnapshot = useRef();\n  const lastSnapshot = useRef();\n  useIsomorphicLayoutEffect(() => {\n    lastSnapshot.current = prevSnapshot.current = snapshot(proxyObject);\n  }, [proxyObject]);\n  useIsomorphicLayoutEffect(() => {\n    lastAffected.current = affected;\n    if (prevSnapshot.current !== lastSnapshot.current && isChanged(prevSnapshot.current, lastSnapshot.current, affected, new WeakMap())) {\n      prevSnapshot.current = lastSnapshot.current;\n      forceUpdate();\n    }\n  });\n  const notifyInSync = options == null ? void 0 : options.sync;\n  const sub = useCallback((proxyObject2, cb) => subscribe(proxyObject2, () => {\n    const nextSnapshot = snapshot(proxyObject2);\n    lastSnapshot.current = nextSnapshot;\n    try {\n      if (lastAffected.current && !isChanged(prevSnapshot.current, nextSnapshot, lastAffected.current, new WeakMap())) {\n        return;\n      }\n    } catch (e) {\n    }\n    prevSnapshot.current = nextSnapshot;\n    cb();\n  }, notifyInSync), [notifyInSync]);\n  const currSnapshot = useMutableSource(getMutableSource(proxyObject), snapshot, sub);\n  if (typeof process === \"object\" && process.env.NODE_ENV !== \"production\") {\n    useAffectedDebugValue(currSnapshot, affected);\n  }\n  const proxyCache = useMemo(() => new WeakMap(), []);\n  return createProxy(currSnapshot, affected, proxyCache);\n};\n\nexport { useSnapshot };\n"],
  "mappings": "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",
  "names": ["getVersion", "subscribe"]
}
